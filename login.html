<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - EveCourse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/login.css">
    <link rel="icon" type="image/png" href="/assets/logo.png">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-book-open"></i>
                </div>
                <h2 class="fw-bold mb-2">Bienvenido a EveCourse</h2>
                <p class="text-muted">Inicia sesión para continuar</p>
            </div>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label fw-bold">
                        <i class="fas fa-envelope me-2"></i>Correo Electrónico
                    </label>
                    <input type="email" class="form-control" id="email" placeholder="tu@email.com" required>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label fw-bold">
                        <i class="fas fa-lock me-2"></i>Contraseña
                    </label>
                    <div class="position-relative">
                        <input type="password" class="form-control" id="password" placeholder="••••••••" required>
                        <span class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <button type="submit" class="btn btn-login-submit" id="btnLogin">
                    <span id="btnText">Iniciar Sesión</span>
                    <span id="spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                </button>
            </form>

            <div id="alertContainer"></div>
        </div>

        <div class="back-home">
            <a href="index.html">
                <i class="fas fa-arrow-left me-2"></i>Volver al inicio
            </a>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script de login -->
    <script>
        // ==============================
        // CONFIGURACIÓN DE SUPABASE
        // ==============================
        const supabaseUrl = "https://aczbveqbxzwaygabuezx.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjemJ2ZXFieHp3YXlnYWJ1ZXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0Nzk3NzAsImV4cCI6MjA3NDA1NTc3MH0.xNxsTIdnKQ2CxsYSvJH9ywE9ESAKeLaIlqe0YJsDwFs";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ==============================
        // VERIFICAR SI YA HAY SESIÓN
        // ==============================
        document.addEventListener("DOMContentLoaded", () => {
            const usuarioStorage = localStorage.getItem("usuario");
            if (usuarioStorage) {
                const usuario = JSON.parse(usuarioStorage);
                // Si ya hay sesión, redirigir según el rol
                if (usuario.id_rol === 1) {
                    window.location.href = "admin-servicios.html";
                } else {
                    window.location.href = "index.html";
                }
            }

            // Configurar eventos
            configurarEventos();
        });

        // ==============================
        // CONFIGURAR EVENTOS
        // ==============================
        function configurarEventos() {
            const form = document.getElementById("loginForm");
            form.addEventListener("submit", handleLogin);

            // Toggle password visibility
            document.querySelector(".toggle-password").addEventListener("click", togglePassword);
        }

        // ==============================
        // FUNCIÓN DE LOGIN
        // ==============================
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            const btnLogin = document.getElementById("btnLogin");
            const btnText = document.getElementById("btnText");
            const spinner = document.getElementById("spinner");

            // Validación básica
            if (!email || !password) {
                showAlert("Por favor completa todos los campos", "warning");
                return;
            }

            // Deshabilitar botón y mostrar spinner
            btnLogin.disabled = true;
            btnText.textContent = "Verificando...";
            spinner.style.display = "inline-block";

            try {
                // Consultar usuario en Supabase
                const { data, error } = await supabase
                    .from("usuario")
                    .select(`
                        *,
                        rol:id_rol(id_rol, nombre, descripcion)
                    `)
                    .eq("email", email)
                    .eq("contrasena", password)
                    .single();

                if (error || !data) {
                    showAlert("Correo o contraseña incorrectos", "danger");
                    console.error("Error:", error);
                } else {
                    // Login exitoso
                    showAlert("¡Inicio de sesión exitoso! Redirigiendo...", "success");
                    
                    // Guardar usuario en localStorage
                    localStorage.setItem("usuario", JSON.stringify(data));

                    // Redirigir según el rol
                    setTimeout(() => {
                        if (data.id_rol === 1) {
                            window.location.href = "admin-servicios.html";
                        } else {
                            window.location.href = "index.html";
                        }
                    }, 1500);
                }
            } catch (err) {
                console.error("Error en login:", err);
                showAlert("Error al iniciar sesión. Intenta nuevamente.", "danger");
            } finally {
                // Rehabilitar botón
                btnLogin.disabled = false;
                btnText.textContent = "Iniciar Sesión";
                spinner.style.display = "none";
            }
        }

        // ==============================
        // MOSTRAR/OCULTAR CONTRASEÑA
        // ==============================
        function togglePassword() {
            const input = document.getElementById("password");
            const icon = document.querySelector(".toggle-password i");
            
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        // ==============================
        // MOSTRAR ALERTAS
        // ==============================
        function showAlert(message, type) {
            const alertContainer = document.getElementById("alertContainer");
            const alertBox = document.createElement("div");
            alertBox.className = `alert alert-${type} mt-3 text-center`;
            alertBox.style.borderRadius = "10px";
            alertBox.style.fontWeight = "500";
            alertBox.textContent = message;
            
            alertContainer.innerHTML = "";
            alertContainer.appendChild(alertBox);
            
            setTimeout(() => alertBox.remove(), 3000);
        }
    </script>
</body>
</html>